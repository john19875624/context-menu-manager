# Context Menu Manager - テストツール

## 概要

このテストツールは、Windows右クリックメニュー管理ツールの各モジュールをテストするためのGUIツールです。

## 機能

### 1. GUIテストランナー (`test_runner.py`)

視覚的にテスト対象を選択して実行できるGUIツールです。

**主な機能:**
- テストケースをカテゴリ別に一覧表示
- 任意のテストを選択して実行
- すべてのテストを一括実行
- 実行結果をリアルタイムで表示
- 成功/失敗/エラーの色分け表示

**実行方法:**
```bash
python test_runner.py
```

### 2. ユニットテスト

各モジュールの詳細なユニットテストです。

#### セキュリティモジュールテスト (`tests/test_security.py`)

SecurityValidatorクラスの機能をテストします。

**テスト項目:**
- コマンド検証
  - 安全なコマンドの許可
  - 危険なコマンドの拒否（削除、シャットダウン、レジストリ操作など）
  - 長さ制限、NULL文字検出
  - ホワイトリストチェック
- 名前検証
  - 禁止文字の検出
  - 予約語のチェック
  - 長さ制限
- アイコンパス検証
  - ファイル存在確認
  - 拡張子チェック
  - ネットワークパス拒否
- JSONインポートのサニタイズ
  - 不正な形式の検出
  - 件数制限
  - 無効項目のフィルタリング

**実行方法:**
```bash
python -m unittest tests.test_security
```

#### データベースモジュールテスト (`tests/test_database.py`)

ContextMenuDatabaseクラスの機能をテストします。

**テスト項目:**
- データベース初期化
  - テーブル作成
  - インデックス作成
- ショートカット追加
  - 基本的な追加
  - アイコン付き追加
  - 複数追加
- ショートカット取得
  - 空のデータベース
  - データ存在時
  - 取得順序
- ショートカット削除
  - 成功ケース
  - 存在しないIDの削除
- システム適用状態更新
  - 単発更新
  - 複数回更新
- 有効/無効切り替え
- レジストリバックアップ
- 監査ログ
  - 追加時のログ記録
  - 削除時のログ記録
  - 件数制限
- JSONエクスポート/インポート
  - エクスポート
  - インポート
  - 重複ショートカットのスキップ

**実行方法:**
```bash
python -m unittest tests.test_database
```

#### システム互換性モジュールテスト (`tests/test_compatibility.py`)

SystemCompatibilityクラスの機能をテストします。

**テスト項目:**
- Windowsバージョン取得
  - 戻り値の形式確認
  - バージョン範囲の妥当性
  - Windows 11検出
- Windows 11互換性チェック
  - 戻り値の型確認
  - 一貫性チェック
- レジストリパス取得
  - 各ターゲットタイプのパス
  - 拡張子指定のパス
  - 未知タイプのデフォルト動作
- レジストリ競合チェック
  - 存在しないキーのチェック
- レジストリバックアップ
  - 存在しないキーのバックアップ
  - バックアップ構造の確認
  - タイムスタンプ形式の確認

**実行方法:**
```bash
python -m unittest tests.test_compatibility
```

### 3. すべてのテストを実行

すべてのユニットテストを一括実行することもできます。

```bash
# testsディレクトリ内のすべてのテストを実行
python -m unittest discover -s tests -p "test_*.py"
```

## テストカテゴリ

GUIテストランナーでは、以下のカテゴリ別にテストが分類されています:

1. **セキュリティ**
   - コマンド検証
   - 名前検証
   - アイコンパス検証

2. **データベース**
   - 初期化
   - ショートカット追加
   - ショートカット削除

3. **システム**
   - Windowsバージョン取得
   - レジストリパス取得

4. **設定**
   - アプリケーション設定値

5. **ユーティリティ**
   - 定数の確認

## 動作要件

- Python 3.7以上
- Windows 10/11
- tkinter（標準ライブラリ）
- 本体のモジュール（context_menu_manager/）

## 使用方法

### GUIテストランナーの使用

1. `test_runner.py` を実行してGUIを起動
2. 左側のツリービューからテストを選択
   - カテゴリをクリックすると、そのカテゴリ内のすべてのテストが展開されます
   - 個別のテストをクリックして選択
   - Ctrl+クリックで複数選択可能
3. 「選択したテストを実行」または「すべて実行」ボタンをクリック
4. 右側のテキストエリアに実行結果が表示されます
5. テスト状態は色分けされます:
   - 緑: 成功
   - 赤: 失敗
   - オレンジ: エラー

### コマンドラインでのユニットテスト実行

個別のテストモジュールを実行:
```bash
# セキュリティテストのみ
python -m unittest tests.test_security

# データベーステストのみ
python -m unittest tests.test_database

# 互換性テストのみ
python -m unittest tests.test_compatibility
```

特定のテストケースクラスを実行:
```bash
python -m unittest tests.test_security.TestSecurityValidator
```

特定のテストメソッドを実行:
```bash
python -m unittest tests.test_security.TestSecurityValidator.test_validate_command_safe
```

詳細モードで実行:
```bash
python -m unittest tests.test_security -v
```

## トラブルシューティング

### インポートエラーが発生する

パスの問題の可能性があります。スクリプトを以下のディレクトリ構造で配置してください:

```
context_menu_manager/
├── test_runner.py          # GUIテストランナー
├── TEST_README.md          # このファイル
├── tests/                  # ユニットテストディレクトリ
│   ├── test_security.py
│   ├── test_database.py
│   └── test_compatibility.py
└── context_menu_manager/   # 本体モジュール
    ├── config.py
    ├── utils.py
    ├── core/
    ├── models/
    ├── managers/
    └── gui/
```

### データベーステストが失敗する

一時ファイルの作成権限があることを確認してください。テストは自動的に一時データベースを作成・削除します。

### レジストリ関連のテストについて

レジストリへの書き込みを伴うテストは、実際のレジストリには影響しません。テストは読み取り専用の操作または一時データでのみ実行されます。

## テスト結果の見方

### 成功例
```
▶ セキュリティ - コマンド検証
  説明: 危険なコマンドパターンの検出テスト
  ✓ 成功
  安全なコマンド: True (OK)
  危険なコマンド(削除): False (エラー: 危険なコマンドパターンが検出されました)
  空のコマンド: False (エラー: コマンドが空です)
```

### 失敗例
```
▶ データベース - ショートカット追加
  説明: ショートカットの追加・取得テスト
  ✗ アサーションエラー: ショートカットの追加に失敗しました
```

### エラー例
```
▶ システム - Windowsバージョン取得
  説明: Windowsバージョン情報の取得テスト
  ✗ エラー: No module named 'winreg'
  Traceback (most recent call last):
    ...
```

## 注意事項

1. **管理者権限は不要です** - テストは通常ユーザー権限で実行できます
2. **実際のレジストリは変更されません** - レジストリ操作のテストは読み取り専用です
3. **一時ファイルは自動削除されます** - テスト用の一時データベースは自動的にクリーンアップされます
4. **Windows専用です** - このテストツールはWindowsでのみ動作します

## ライセンス

Context Menu Managerと同じライセンスが適用されます。

## バージョン履歴

### Version 1.0.0 (2025-01-03)
- 初回リリース
- GUIテストランナーを実装
- セキュリティ、データベース、互換性モジュールのユニットテストを実装
